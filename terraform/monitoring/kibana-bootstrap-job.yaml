apiVersion: batch/v1
kind: Job
metadata:
  name: kibana-bootstrap
  namespace: monitoring
spec:
  backoffLimit: 6
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: create-dataview
          image: curlimages/curl:8.10.0
          command: ["/bin/sh","-c"]
          args:
            - |
              set -e
              KIBANA_URL="http://kibana.monitoring.svc.cluster.local:5601"
              echo "Waiting for Kibana..."
              for i in $(seq 1 60); do
                code=$(curl -sS -o /dev/null -w "%{http_code}" "$KIBANA_URL/api/status" || true)
                [ "$code" = "200" ] && break
                sleep 5
              done
              echo "Creating data view fluent-bit*..."
              curl -sS -X POST "$KIBANA_URL/api/data_views/data_view" \
                -H "kbn-xsrf: true" -H "Content-Type: application/json" \
                -d '{"data_view":{"title":"fluent-bit*","timeFieldName":"@timestamp","name":"fluent-bit"}}' || true
